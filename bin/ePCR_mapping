#!/usr/bin/perl

=head1 NAME

ePCR_mapping - mapping to reference genome/assemblied contigs by PCR pattern.

=head1 DESCRIPTION

Aim to extract PCR product fragments by ePCR.
 
 Author	: Yuanda Lv
 E-mail	: Lyd0527@126.com
 Date	: 10/07/2013
 Version: 1.0
=cut

use strict;
use Getopt::Long;

my $usage = q/
ePCR_mapping v1.0 10-07-2013

USAGE:

perl ePCR_mapping [-i probes_prefix] [-d database][-m mismatch] [-s product_size_max] [-t thread]

Description:

parameter:
-i	probes prefix
-d	database
-m	num of mismatch (<=3)
-s	maximum product size
-t	num of thread
	
Example: perl ePCR_mapping -i probe -d reference.fa -m 3 -t 10
/;

die $usage."\n" if (@ARGV<1);

my $input;
my $db;
my $mismatch=0;
my $thread=4;
my $product=600;

GetOptions(
	'i:s'	=>\$input,
	'd:s'	=>\$db,
	'm:n'	=>\$mismatch,
	's:n'	=>\$product,
	't:n'	=>\$thread,
);

my $formatdb="bowtie-build $db db\/db_bowtie >>/dev/null";
$db =~ s/\..*$//;
my $epcr1="bowtie -f -S -p $thread -m 1 -X $product -v $mismatch $db\_bowtie -1 $input\_1.fa -2 $input\_2.fa | tee target.sam | grep -v -P '\\*\t0\t0\t\\*|@|-' | cut -f 1,9 >target.size";
my $epcr2="bowtie -f -S -p $thread -m 1 -X $product -v $mismatch db/db_bowtie -1 $input\_1.fa -2 $input\_2.fa | tee target.sam | grep -v -P '\\*\t0\t0\t\\*|@|-'| cut -f 1,9 >target.size";

if(-e "$db\_bowtie.1.ebwt") {
	system($epcr1);
}else{
	if (!(-e "db")){
		mkdir "db";
	}
	printf "bowtie_db doesn't exist. formatting it now\n";
	system($formatdb);
	system($epcr2);
}

#merge
#awk '{a[$1]=a[$1]?a[$1]","$2:$2} END{for(i in a)print i,a[i]}' i
